<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ‰‹æœºæ‰«ç æµ‹è¯•</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;margin:0;padding:16px;max-width:860px}
    .card{border:1px solid #e2e8f0;border-radius:12px;padding:12px;margin-top:12px}
    .btn{padding:10px 12px;border:1px solid #cbd5e1;border-radius:8;background:#f8fafc;cursor:pointer}
    .btn.pri{background:#2563eb;color:#fff;border-color:#1d4ed8}
    .btn.dng{background:#ef4444;color:#fff;border-color:#dc2626}
    #log{white-space:pre-wrap;font-size:12px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8;padding:10px;max-height:320px;overflow:auto}
    #view{width:100%;min-height:260px;border-radius:12px;overflow:hidden}
  </style>
</head>
<body>
  <h1>æ‰‹æœºæ‰«ç æµ‹è¯•ï¼ˆçº¯é™æ€ï¼‰</h1>
  <p style="opacity:.8">è¦æ±‚ï¼šHTTPSã€ç³»ç»Ÿ Safari/Chromeã€éæ— ç—•ï¼Œå¹¶å…è®¸æµè§ˆå™¨ç›¸æœºæƒé™ã€‚</p>

  <div style="display:flex;gap:8;flex-wrap:wrap;margin-top:12px">
    <button class="btn pri" id="open">ğŸ“· æ‰“å¼€æ‘„åƒå¤´æ‰«ç </button>
    <button class="btn dng" id="stop" disabled>â¹ åœæ­¢ç›¸æœº</button>
    <input type="file" id="file" accept="image/*" capture="environment" style="margin-left:8px" />
  </div>

  <div id="scanner" class="card">
    <div id="view"></div>
    <p style="font-size:12;opacity:.7;margin-top:8">
      å¦‚æœé»‘å±/æ‰“ä¸å¼€ï¼šè®¾ç½®â†’Safari/Chromeâ†’ç›¸æœºâ†’å…è®¸ï¼›ç¡®è®¤ä½¿ç”¨ HTTPSï¼›éæ— ç—•ï¼›ä¸è¦ç”¨ App å†…ç½®æµè§ˆå™¨ã€‚
    </p>
  </div>

  <h3 style="margin-top:18px">æ—¥å¿—</h3>
  <pre id="log"></pre>

  <!-- æŒ‰éœ€ä» CDN åŠ è½½æ‰«ç åº“ -->
  <script>
    let inst = null;

    function log(s){ const el=document.getElementById('log'); el.textContent = `[${new Date().toLocaleTimeString()}] ${s}\n` + el.textContent; }

    function loadLib(){
      return new Promise((res, rej)=>{
        if(window.Html5Qrcode) return res(window.Html5Qrcode);
        const s=document.createElement('script');
        s.src='https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js';
        s.async=true;
        s.onload=()=> window.Html5Qrcode ? res(window.Html5Qrcode) : rej(new Error('åŠ è½½å¤±è´¥'));
        s.onerror=()=> rej(new Error('æ— æ³•åŠ è½½ html5-qrcode'));
        document.body.appendChild(s);
      });
    }

    async function openCam(){
      document.getElementById('open').disabled = true;
      try{
        if(!window.isSecureContext) { log('é HTTPS ç¯å¢ƒï¼Œæ”¹ç”¨æ‹ç…§è¯†åˆ«ã€‚'); return; }
        if(!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)){ log('æµè§ˆå™¨ä¸æ”¯æŒ getUserMediaï¼Œæ”¹ç”¨æ‹ç…§è¯†åˆ«ã€‚'); return; }

        const Html5Qrcode = await loadLib();
        const id='qr-' + Math.random().toString(36).slice(2);
        const view=document.getElementById('view');
        view.innerHTML = `<div id="${id}" style="width:100%"></div>`;
        inst = new Html5Qrcode(id);
        await inst.start(
          { facingMode: { ideal: 'environment' } },
          { fps: 5, qrbox: { width: 240, height: 240 } },
          (txt)=>{ log('è¯†åˆ«æˆåŠŸï¼š'+txt); alert('è¯†åˆ«æˆåŠŸï¼š'+txt); stopCam(); },
          ()=>{}
        );
        document.getElementById('stop').disabled = false;
        log('ç›¸æœºå·²å¯åŠ¨ âœ…');
      }catch(e){
        log('ç›¸æœºå¯åŠ¨å¤±è´¥ï¼š' + (e.name || e.message || e));
        document.getElementById('open').disabled = false;
      }
    }

    async function stopCam(){
      try{ await inst?.stop(); }catch{}
      try{ await inst?.clear(); }catch{}
      inst=null;
      document.getElementById('stop').disabled = true;
      document.getElementById('open').disabled = false;
    }

    async function scanFile(file){
      try{
        const Html5Qrcode = await loadLib();
        const id='qr-file-' + Math.random().toString(36).slice(2);
        const view=document.getElementById('view');
        view.innerHTML = `<div id="${id}" style="display:none"></div>`;
        const r=new Html5Qrcode(id);
        const txt=await r.scanFile(file,true);
        await r.clear();
        log('å›¾ç‰‡è¯†åˆ«æˆåŠŸï¼š'+txt);
        alert('å›¾ç‰‡è¯†åˆ«æˆåŠŸï¼š'+txt);
        stopCam();
      }catch(e){
        log('å›¾ç‰‡è¯†åˆ«å¤±è´¥ï¼š' + (e.message || e));
        alert('æ— æ³•è¯†åˆ«è¯¥å›¾ç‰‡ä¸­çš„äºŒç»´ç ï¼Œè¯·é‡è¯•/å…‰çº¿æ›´äº®äº›ã€‚');
      }
    }

    document.getElementById('open').onclick = openCam;
    document.getElementById('stop').onclick = stopCam;
    document.getElementById('file').onchange = (e)=>{ const f=e.target.files?.[0]; if(f) scanFile(f); e.target.value=''; }
  </script>
</body>
</html>
