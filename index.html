async function openScanner() {
  setOpen(true);
  setFallback(false);
  p('打开相机中…');

  try {
    // 1) 预热权限（最宽松的请求，触发授权弹窗）
    const pre = await navigator.mediaDevices.getUserMedia({ video: true });
    // 立即停止预热流，避免占用
    pre.getTracks().forEach(t => t.stop());

    // 2) 枚举设备，尽量选“后置摄像头”
    const devs = await navigator.mediaDevices.enumerateDevices();
    const videos = devs.filter(d => d.kind === 'videoinput');

    // 规则：优先找 label 包含 back / rear；否则取最后一个
    let backCam = videos.find(d => /back|rear|environment/i.test(d.label));
    if (!backCam && videos.length) backCam = videos[videos.length - 1];
    const deviceId = backCam?.deviceId;

    // 3) 检查基础环境
    const isSecure = window.isSecureContext;
    const canGUM = !!navigator.mediaDevices?.getUserMedia;
    if (!isSecure || !canGUM) {
      setFallback(true);
      p('非 HTTPS 或浏览器不支持 getUserMedia，启用拍照识别。');
      return;
    }

    // 4) 动态加载库并启动 html5-qrcode（指定 deviceId）
    const Html5Qrcode = await loadHtml5Qrcode();
    if (!mountRef.current) return;

    const id = 'qr-' + Math.random().toString(36).slice(2);
    mountRef.current.innerHTML = `<div id="${id}" style="width:100%"></div>`;
    const inst = new Html5Qrcode(id);
    scannerRef.current = inst;

    const cameraConfig = deviceId
      ? { deviceId: { exact: deviceId } } // 精准使用后置
      : { facingMode: { ideal: 'environment' } }; // 退路

    await inst.start(
      cameraConfig,
      { fps: 5, qrbox: { width: 240, height: 240 } }, // iOS 稳一点
      (txt: string) => {
        p('识别成功：' + txt);
        alert('识别成功：' + txt);
        stopScanner();
      },
      () => {}
    );

    p('相机已启动 ✅');
    document.getElementById('stop')?.removeAttribute('disabled');
  } catch (e: any) {
    // 常见错误名直说原因
    const name = e?.name || '';
    if (/NotAllowedError|Permission/i.test(name)) {
      p('相机启动失败：未授予权限（到 设置→Safari/Chrome→相机→允许）');
    } else if (/NotFoundError|Overconstrained/i.test(name)) {
      p('相机启动失败：未找到可用摄像头或被占用（关闭占用相机的 App 重试）');
    } else if (/NotSupportedError/i.test(name)) {
      p('相机启动失败：环境不支持（HTTP/无痕/安全头拦截）');
    } else {
      p('相机启动失败：' + (e?.message || String(e)));
    }
    setFallback(true); // 自动切到拍照/相册识别
  }
}
